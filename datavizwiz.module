<?php


function datavizwiz_theme_registry_alter(&$theme_registry) {
  // Remove the first path under 'node' which is the one for the
  // module that created the template
  $template = 'node';
  $originalpath = array_shift($theme_registry[$template]['theme paths']);
  
  // Get the path to your module
  $modulepath = drupal_get_path('module', 'datavizwiz');

  // Stick the original path and then your module path back on top
  array_unshift($theme_registry[$template]['theme paths'], $originalpath, $modulepath);
}

function datavizwiz_theme() {
  return array(
      'datavizwiz_displaydata' => array(
          'arguments' => array('node' => NULL),
      ),
  );
}

function theme_datavizwiz_displaydata($node) {
    drupal_add_js(drupal_get_path('module', 'datavizwiz').'/libraries/mapping/openlayers/OpenLayers.js');
    _datavizwiz_add_javascript();
  
  $data_table_name = $node->field_dvw_datatable[0]['value'];
  
  $query = db_query("SELECT * FROM {%s}",$data_table_name);
  
  $header = NULL;
  $rows = array();
  
  // Loop thhrough all records, stuff records in array
  while ($row = db_fetch_array($query)) {
    // If this is our first record, let's fill the $header array with column names
    if ($header == NULL) {
      $header = array_keys($row);
    }
    
       array_push($rows, $row);
  }


  
  
  
  $output = theme_table($header, $rows);
  return $output;
}

function _datavizwiz_add_javascript() {
  $script = "        var map, layer;

        function mapInit(){
            //OpenLayers.ProxyHost='/proxy/?url=';
            map = new OpenLayers.Map('datamap');
            layer = new OpenLayers.Layer.WMS( 'OpenLayers WMS', 
                'http://vmap0.tiles.osgeo.org/wms/vmap0', {layers: 'basic'} );
                
            map.addLayer(layer);
            map.setCenter(new OpenLayers.LonLat(0, 0), 0);

            var newl = new OpenLayers.Layer.Text( 'text', { location:'/textfile.txt'} );
            map.addLayer(newl);

            var markers = new OpenLayers.Layer.Markers('Markers');
            map.addLayer(markers);

            var size = new OpenLayers.Size(21,25);
            var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
            var icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png',size,offset);
            markers.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(0,0),icon));

            var halfIcon = icon.clone();
            markers.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(0,45),halfIcon));

            marker = new OpenLayers.Marker(new OpenLayers.LonLat(90,10),icon.clone());
            marker.setOpacity(0.2);
            marker.events.register('mousedown', marker, function(evt) { alert(this.icon.url); OpenLayers.Event.stop(evt); });
            markers.addMarker(marker); 
            map.addControl(new OpenLayers.Control.LayerSwitcher());
            map.zoomToMaxExtent();

            halfIcon.setOpacity(0.5);
        };

        $(function() { mapInit(); });
";
  drupal_add_js($script, 'inline');
}